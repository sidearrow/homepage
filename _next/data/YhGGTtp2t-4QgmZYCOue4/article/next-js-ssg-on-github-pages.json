{"pageProps":{"article":{"id":"next-js-ssg-on-github-pages","title":"Next.js の SSG 機能で出力した静的サイトを GitHub Pages で公開する","description":"Next.js の SSG 機能で出力した静的サイトを GitHub Pages で公開する手順です。","content":"<h1 id=\"nextjs-の-ssg-機能で出力した静的サイトを-github-pages-で公開する\">Next.js の SSG 機能で出力した静的サイトを GitHub Pages で公開する</h1>\n<h2 id=\"環境\">環境</h2>\n<ul>\n<li>Next.js: 9.5.3</li>\n</ul>\n<h2 id=\"nextjs-で-ssg-する\">Next.js で SSG する</h2>\n<p><code>next build</code> 後に <code>next export</code> で、<code>out</code> フォルダに HTML, CSS, JS 等が出力される。\n<code>package.json</code> の <code>scripts</code> に 以下あたりを追加しておく。</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"scripts\"</span>: {\n    <span class=\"hljs-attr\">\"build\"</span>: <span class=\"hljs-string\">\"next build &amp;&amp; next export\"</span>\n  }\n}</code></pre>\n<h2 id=\"nextjs-アプリのビルド時の注意点\">Next.js アプリのビルド時の注意点</h2>\n<p>GitHub リポジトリ名が <code>&lt;ユーザー名&gt;.github.io</code> の場合、公開 URL は <code>https://&lt;ユーザー名&gt;.github.io</code> だが、\nそれ以外のリポジトリ名の場合、公開 URL は <code>https://&lt;ユーザー名&gt;.github.io/&lt;リポジトリ名&gt;</code> になる。</p>\n<p>そのため、後者の場合、Next.js をビルドする際は <code>next.config.js</code> に設定を追加する必要がある。</p>\n<pre><code class=\"language-js\"><span class=\"hljs-built_in\">module</span>.exports = {\n  <span class=\"hljs-attr\">assetPrefix</span>: <span class=\"hljs-string\">'&lt;プレフィックス（本ケースではリポジトリ名）&gt;'</span>,\n};</code></pre>\n<p>（参考）<a href=\"https://nextjs.org/docs/api-reference/next.config.js/cdn-support-with-asset-prefix\">https://nextjs.org/docs/api-reference/next.config.js/cdn-support-with-asset-prefix</a></p>\n<p>ただ、上記の設定では開発時も適用される。環境変数で設定を出し分ける方法もあるが、Next.js で用意されている定数 <code>PHASE_*</code> を利用する。</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">const</span> { PHASE_PRODUCTION_BUILD } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'next/constants'</span>);\n\n<span class=\"hljs-built_in\">module</span>.exports = <span class=\"hljs-function\">(<span class=\"hljs-params\">phase, { defaultConfig }</span>) =&gt;</span> {\n  <span class=\"hljs-keyword\">if</span> (phase === PHASE_PRODUCTION_BUILD) {\n    <span class=\"hljs-keyword\">return</span> { <span class=\"hljs-attr\">assetPrefix</span>: <span class=\"hljs-string\">'...'</span> };\n  }\n  <span class=\"hljs-keyword\">return</span> {};\n};</code></pre>\n<p>（参考）<a href=\"https://nextjs.org/docs/api-reference/next.config.js/introduction\">https://nextjs.org/docs/api-reference/next.config.js/introduction</a></p>\n<h2 id=\"github-actions-の設定\">GitHub Actions の設定</h2>\n<p><code>.github/workflows</code> ディレクトリ配下に適当な名前で以下のような yml を作成。\n公開ディレクトリ直下に <code>.nojekyll</code> といったファイルがないと、<code>_next</code> ディレクトリが公開されないようなので、ビルド後に作成している。</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">github</span> <span class=\"hljs-string\">pages</span>\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">branches:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">master</span>\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">deploy:</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v2.1.0</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-number\">12.</span><span class=\"hljs-string\">x</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">install</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">yarn</span> <span class=\"hljs-string\">install</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">build</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          yarn run build\n          touch out/.nojekyll\n</span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">deploy</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">peaceiris/actions-gh-pages@v3.6.4</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">github_token:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.GITHUB_TOKEN</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">publish_dir:</span> <span class=\"hljs-string\">./out</span></code></pre>\n","tags":[]}},"__N_SSG":true}